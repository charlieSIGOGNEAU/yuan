<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Accueil</title>
    <!-- Action Cable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rails-actioncable/7.0.0/actioncable.min.js"></script>
</head>
<body>
    <button onclick="logout()">Se d√©connecter</button>
    <button onclick="quickGame()">Partie rapide</button>
    <button onclick="customGame()">Partie personnalis√©e</button>
    <div id="gameInfo"></div>

    <script>
        // Configuration d'Action Cable
        const cable = ActionCable.createConsumer('ws://localhost:3000/cable');
        
        // R√©cup√©rer le token du localStorage
        const token = localStorage.getItem('token');

        // V√©rifier si l'utilisateur est connect√©
        if (!token) {
            window.location.href = 'test.html';
        }

        async function logout() {
            localStorage.removeItem('token');
            window.location.href = 'test.html';
        }

        async function quickGame() {
            try {
                console.log('Tentative de cr√©ation/rejoindre une partie rapide...');
                const response = await fetch('http://localhost:3000/games/quick', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Erreur lors de la cr√©ation de la partie');
                }

                const game = await response.json();
                console.log('R√©ponse du serveur:', game);
                
                // Afficher les informations de la partie
                const gameInfo = document.getElementById('gameInfo');
                gameInfo.innerHTML = `
                    <h3>Informations de la partie :</h3>
                    <div data-game-id="${game.game.id}">
                        <p>Statut: <span id="game-status">${game.game.game_status}</span></p>
                        <div id="players-list">
                            ${game.game.game_users.map(gameUser => `
                                <div class="player">
                                    <span class="player-name">${gameUser.user_name}</span>
                                    <span class="player-status">${gameUser.status}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                // S'abonner aux mises √† jour de la partie
                cable.subscriptions.create(
                    { channel: "GameChannel", game_id: game.game.id },
                    {
                        connected() {
                            console.log("‚úÖ Connect√© au channel de la partie");
                        },
                        disconnected() {
                            console.log("‚ùå D√©connect√© du channel de la partie");
                        },
                        received(data) {
                            console.log("üì® Donn√©es re√ßues:", data);
                            // Mettre √† jour l'interface
                            const gameStatus = document.querySelector("#game-status");
                            if (gameStatus) {
                                gameStatus.textContent = data.game.game_status;
                            }
                            
                            const playersList = document.querySelector("#players-list");
                            if (playersList) {
                                playersList.innerHTML = data.game.game_users.map(gameUser => `
                                    <div class="player">
                                        <span class="player-name">${gameUser.user_name}</span>
                                        <span class="player-status">${gameUser.status}</span>
                                    </div>
                                `).join('');
                            }

                            // Si la partie est compl√®te, rediriger vers la page de jeu
                            if (data.game.game_users.length === 3) {
                                window.location.href = `/games/${data.game.id}`;
                            }
                        }
                    }
                );
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('gameInfo').innerHTML = `
                    <h3>Erreur :</h3>
                    <p>${error.message}</p>
                `;
            }
        }

        function customGame() {
            // √Ä impl√©menter plus tard
            console.log('Partie personnalis√©e - √Ä venir');
        }
    </script>
</body>
</html> 