<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test WebSocket - ActionCable</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        input[type="text"] {
            width: 300px;
            padding: 5px;
            margin: 5px;
        }
    </style>
</head>
<body>
    <h1>Test Connexion WebSocket ActionCable</h1>
    
    <div id="status" class="status disconnected">
        Statut: D√©connect√©
    </div>

    <div>
        <button id="connectBtn" onclick="connectWebSocket()">Se connecter</button>
        <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled>Se d√©connecter</button>
        <button id="pingBtn" onclick="sendPing()" disabled>Test Ping</button>
    </div>

    <div>
        <input type="text" id="messageInput" placeholder="Tapez votre message ici..." disabled>
        <button id="sendBtn" onclick="sendMessage()" disabled>Envoyer</button>
    </div>

    <div>
        <label>
            <input type="checkbox" id="autoPingCheckbox" onchange="toggleAutoPing()"> 
            Ping automatique toutes les 10 secondes
        </label>
        <span id="connectionTime" style="margin-left: 20px; font-weight: bold;"></span>
    </div>

    <h3>Logs de connexion:</h3>
    <div id="log" class="log"></div>

    <script src="https://cdn.jsdelivr.net/npm/@rails/actioncable@7.0.0/app/assets/javascripts/actioncable.js"></script>
    <script>
        let cable;
        let subscription;
        let connected = false;
        let autoPingInterval = null;
        let connectionStartTime = null;
        let connectionTimerInterval = null;
        let pingStartTime = null;

        const statusDiv = document.getElementById('status');
        const logDiv = document.getElementById('log');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const pingBtn = document.getElementById('pingBtn');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const autoPingCheckbox = document.getElementById('autoPingCheckbox');
        const connectionTimeSpan = document.getElementById('connectionTime');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[WebSocket] ${message}`);
        }

        function updateStatus(isConnected) {
            connected = isConnected;
            if (isConnected) {
                connectionStartTime = new Date();
                statusDiv.textContent = 'Statut: Connect√©';
                statusDiv.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                pingBtn.disabled = false;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                
                // D√©marrer le timer de connexion
                updateConnectionTimer();
                connectionTimerInterval = setInterval(updateConnectionTimer, 1000);
            } else {
                connectionStartTime = null;
                statusDiv.textContent = 'Statut: D√©connect√©';
                statusDiv.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                pingBtn.disabled = true;
                messageInput.disabled = true;
                sendBtn.disabled = true;
                autoPingCheckbox.checked = false;
                autoPingCheckbox.disabled = false;
                
                // Arr√™ter les timers
                stopAutoPing();
                if (connectionTimerInterval) {
                    clearInterval(connectionTimerInterval);
                    connectionTimerInterval = null;
                }
                connectionTimeSpan.textContent = '';
            }
        }

        function updateConnectionTimer() {
            if (connectionStartTime) {
                const now = new Date();
                const diffInSeconds = Math.floor((now - connectionStartTime) / 1000);
                const minutes = Math.floor(diffInSeconds / 60);
                const seconds = diffInSeconds % 60;
                connectionTimeSpan.textContent = `Connect√© depuis: ${minutes}m ${seconds}s`;
                connectionTimeSpan.style.color = '#155724';
            }
        }

        function connectWebSocket() {
            try {
                log('üîÑ Tentative de connexion...');
                
                // Cr√©er la connexion ActionCable
                cable = ActionCable.createConsumer('ws://localhost:3000/cable');
                
                log('üì° Consumer ActionCable cr√©√©');

                // S'abonner au canal de test
                subscription = cable.subscriptions.create('TestChannel', {
                    connected() {
                        log('‚úÖ Connect√© au TestChannel');
                        updateStatus(true);
                    },

                    disconnected() {
                        log('‚ùå D√©connect√© du TestChannel');
                        updateStatus(false);
                    },

                    received(data) {
                        log(`üì® Message re√ßu: ${JSON.stringify(data)}`);
                        
                        // Traitement sp√©cial pour les pongs
                        if (data.type === 'pong') {
                            const latency = new Date() - pingStartTime;
                            log(`üèì SERVEUR ‚Üí CLIENT: Pong re√ßu ! Latence: ${latency}ms`);
                            connectionTimeSpan.style.color = latency < 100 ? '#155724' : (latency < 500 ? '#856404' : '#721c24');
                        }
                        
                        // Traitement des pings du serveur
                        if (data.type === 'server_ping') {
                            log(`üì° SERVEUR ‚Üí CLIENT: Ping du serveur re√ßu ! Envoi de la r√©ponse automatique...`);
                            
                            // R√©pondre automatiquement au ping du serveur
                            subscription.perform('server_pong', {
                                received_at: new Date().toISOString(),
                                original_message: data
                            });
                        }
                        
                        // Traitement de la r√©ponse au ping du serveur
                        if (data.type === 'server_pong_ack') {
                            log(`‚úÖ SERVEUR ‚Üí CLIENT: Confirmation - Le serveur a re√ßu notre r√©ponse`);
                        }
                    }
                });

            } catch (error) {
                log(`‚ùå Erreur de connexion: ${error.message}`);
                updateStatus(false);
            }
        }

        function disconnectWebSocket() {
            if (subscription) {
                subscription.unsubscribe();
                log('üîå D√©connexion demand√©e');
            }
            if (cable) {
                cable.disconnect();
                cable = null;
            }
            updateStatus(false);
        }

        function sendMessage() {
            if (!connected || !subscription) {
                log('‚ùå Pas de connexion active');
                return;
            }

            const message = messageInput.value.trim();
            if (!message) {
                log('‚ùå Message vide');
                return;
            }

            log(`üì§ Envoi du message: "${message}"`);
            subscription.perform('receive', { message: message });
            messageInput.value = '';
        }

        function sendPing() {
            if (!connected || !subscription) {
                log('‚ùå Pas de connexion active');
                return;
            }

            log('üì§ CLIENT ‚Üí SERVEUR: Envoi du ping');
            subscription.perform('ping');
            pingStartTime = new Date();
        }

        function toggleAutoPing() {
            if (autoPingCheckbox.checked) {
                startAutoPing();
            } else {
                stopAutoPing();
            }
        }

        function startAutoPing() {
            if (!connected || !subscription) {
                log('‚ùå Pas de connexion active');
                return;
            }

            log('üîÑ D√©marrage du ping automatique');
            autoPingCheckbox.disabled = true;
            sendPing();

            connectionTimeSpan.textContent = 'En cours...';
            connectionTimeSpan.style.fontWeight = 'bold';

            autoPingInterval = setInterval(() => {
                sendPing();
            }, 10000);
        }

        function stopAutoPing() {
            if (autoPingInterval) {
                clearInterval(autoPingInterval);
                autoPingInterval = null;
            }
            autoPingCheckbox.disabled = false;
            connectionTimeSpan.textContent = 'Ping automatique arr√™t√©';
            connectionTimeSpan.style.fontWeight = 'normal';
        }

        // Envoyer un message avec Enter
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Log initial
        log('üöÄ Page charg√©e, pr√™t √† se connecter');
    </script>
</body>
</html> 