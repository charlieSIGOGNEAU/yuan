<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Accueil - Mon Jeu</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        #userInfo { margin-bottom: 20px; padding: 10px; background-color: #f0f0f0; border: 1px solid #ccc; }
        button { padding: 10px; margin-right: 10px; font-size: 1em; cursor: pointer; }
        #gameActions button { background-color: #4CAF50; color: white; border: none; }
        #logoutButton { background-color: #f44336; color: white; border: none; }
        /* Pour ActionCable, vous devez servir actioncable.js et l'inclure ici */
        /* ex: <script src="./actioncable.js"></script> */
        /* Vous pouvez trouver actioncable.js dans le code source de la gem ActionCable */
    </style>
    <script src="./actioncable.js"></script>
</head>
<body>
    <div id="userInfo">
        Bonjour, <span id="userName"></span>! (Statut WebSocket: <span id="wsStatus">déconnecté</span>)
    </div>

    <button id="logoutButton">Déconnexion</button>
    
    <div id="gameActions" style="margin-top: 20px;">
        <h2>Actions de Jeu</h2>
        <button id="quickGameButton">Partie Rapide</button>
        <button id="customGameButton">Partie Personnalisée</button>
    </div>

    <div id="gameUpdates" style="margin-top: 20px; padding:10px; border:1px dashed #999;">
        <h3>Mises à jour du jeu (via WebSocket):</h3>
        <div id="messages"></div>
    </div>
    <div id="debugLogOutput" style="margin-top: 20px; padding: 10px; border: 1px solid #ddd; background-color: #f9f9f9;">
        <h3>Logs de débogage :</h3>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const userNameSpan = document.getElementById("userName");
            const logoutButton = document.getElementById("logoutButton");
            const quickGameButton = document.getElementById("quickGameButton");
            const customGameButton = document.getElementById("customGameButton");
            const wsStatusSpan = document.getElementById("wsStatus");
            const messagesDiv = document.getElementById("messages");
            const debugLogOutputDiv = document.getElementById("debugLogOutput"); // Pour la fonction debugLog

            const JWT_KEY = "jwt_token";
            const USER_NAME_KEY = "user_name";
            let cable = null; // Pour stocker l'instance de ActionCable.createConsumer
            let gameChannelSubscription = null; // Pour stocker l'abonnement au channel de jeu

            const token = localStorage.getItem(JWT_KEY);
            const userName = localStorage.getItem(USER_NAME_KEY);

            // Fonction de débogage
            function debugLog(message) {
                console.log(message);
                const logEntry = document.createElement("p");
                logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                debugLogOutputDiv.appendChild(logEntry);
            }

            if (!token) {
                debugLog("No token found, redirecting to login.");
                window.location.href = "connection.html";
                return; // Arrêter l'exécution du script si pas de token
            }

            if (userName) {
                userNameSpan.textContent = userName;
            } else {
                // Si le nom n'est pas dans localStorage, on pourrait le déduire du token ou laisser vide
                userNameSpan.textContent = "Utilisateur"; 
            }

            function connectWebSocketWithToken(token) {
                if (typeof ActionCable === 'undefined') {
                    debugLog("Erreur: ActionCable n'est pas chargé. Assurez-vous que le script actioncable.js est inclus et chargé avant ce script.");
                    wsStatusSpan.textContent = "erreur (ActionCable non défini)";
                    return;
                }

                if (cable && cable.connection && cable.connection.isOpen()) {
                    debugLog("ActionCable connection is ALREADY open.");
                    wsStatusSpan.textContent = "connecté (AC)";
                    return;
                }

                debugLog("Attempting to connect ActionCable (SIMPLIFIED, NO TOKEN)...");
                wsStatusSpan.textContent = "connexion simplifiée (AC)...";
                
                if (cable) {
                    cable.disconnect();
                }
                // Connexion SANS le token pour l'instant
                cable = ActionCable.createConsumer(`ws://localhost:3000/cable`); 

                debugLog("ActionCable.createConsumer (simplified) called. Inspecting 'cable' object:");
                console.log(cable);
                debugLog("Inspecting 'cable.connection' (simplified) object:");
                console.log(cable.connection);

                if (cable && cable.connection) {
                    cable.connection.onopen = () => {
                        debugLog("SUCCESS: ActionCable connection.onopen event triggered!");
                        wsStatusSpan.textContent = "connecté (AC) - SIMPLIFIÉ";
                    };
                    cable.connection.onclose = () => {
                        debugLog("EVENT: ActionCable connection.onclose event triggered.");
                        wsStatusSpan.textContent = "déconnecté (AC) - SIMPLIFIÉ";
                        // Pas de reconnexion automatique pour ce test simplifié
                    };
                    cable.connection.onerror = (errorEvent) => {
                        debugLog("ERROR: ActionCable connection.onerror event triggered. See browser console for details.");
                        console.error("ActionCable WebSocket Error Event (simplified test):", errorEvent);
                        wsStatusSpan.textContent = "erreur connexion (AC) - SIMPLIFIÉ";
                    };
                } else {
                    debugLog("Failed to create ActionCable consumer or connection object (simplified test).");
                    wsStatusSpan.textContent = "erreur init (AC) - SIMPLIFIÉ";
                }
            }

            function subscribeToGameChannel(gameId) {
                if (!cable) {
                    debugLog("ActionCable n'est pas initialisé. Impossible de s'abonner au channel de jeu.");
                    return;
                }
                if (!cable.connection || !cable.connection.isOpen()) {
                    debugLog("ActionCable connection is not open. Cannot subscribe to game channel.");
                     // Tenter de se reconnecter ou informer l'utilisateur
                    connectWebSocketWithToken(localStorage.getItem(JWT_KEY)); 
                    return;
                }

                // Se désabonner de l'ancien channel de jeu s'il existe
                if (gameChannelSubscription) {
                    debugLog(`Se désabonne de l'ancien channel: ${gameChannelSubscription.identifier}`);
                    gameChannelSubscription.unsubscribe();
                    gameChannelSubscription = null;
                }

                debugLog(`Tentative d'abonnement à GameChannel pour la partie ${gameId}`);
                gameChannelSubscription = cable.subscriptions.create(
                    { channel: "GameChannel", game_id: gameId }, 
                    {
                        connected: () => {
                            debugLog(`Abonné avec succès à GameChannel pour la partie ${gameId}!`);
                            messagesDiv.innerHTML = `<p>Connecté au canal de la partie ${gameId}. En attente de joueurs/démarrage...</p>`;
                            // Vous pouvez envoyer un message pour confirmer l'abonnement ou autre si nécessaire
                            // gameChannelSubscription.send({ message: "Hello from client to game_" + gameId });
                        },
                        disconnected: (error) => {
                            // L'événement 'disconnected' peut aussi être appelé suite à un `reject` du serveur.
                            // error contiendra { reason: "rejected" } dans ce cas.
                            let reason = error && error.reason ? error.reason : "Raison inconnue";
                            debugLog(`Déconnecté de GameChannel pour la partie ${gameId}. Raison: ${reason}`);
                            messagesDiv.innerHTML += `<p style="color:red;">Déconnexion du canal de la partie ${gameId}. Raison: ${reason}.</p>`;
                            if (reason === "rejected") {
                                alert(`Impossible de rejoindre le canal de la partie ${gameId}. Vérifiez les logs du serveur.`);
                            }
                        },
                        received: (data) => {
                            debugLog(`Message reçu sur GameChannel (partie ${gameId}): ${JSON.stringify(data)}`);
                            const messageElement = document.createElement("p");
                            messageElement.textContent = `[Partie ${gameId}] ${JSON.stringify(data)}`; 
                            messagesDiv.appendChild(messageElement);
                            
                            if (data.type === "game_start") {
                                alert(`La partie ${data.game.id} commence ! Joueurs: ${data.game.game_users.map(gu => gu.user_id).join(', ')}`);
                                // Mettre à jour l'UI avec les détails de la partie (data.game)
                            } else if (data.message) {
                                // Gérer d'autres types de messages
                                messagesDiv.innerHTML += `<p>Message: ${data.message}</p>`;
                            }
                        }
                    }
                );
            }

            // Initialiser la connexion ActionCable (sans abonnement à un channel spécifique pour l'instant)
            connectWebSocketWithToken(token);

            logoutButton.addEventListener("click", function() {
                localStorage.removeItem(JWT_KEY);
                localStorage.removeItem(USER_NAME_KEY);
                // if (webSocket) { // Ancien code WebSocket direct
                //     webSocket.onclose = null; 
                //     webSocket.close();
                // }
                // Pour ActionCable, il faut se désabonner et potentiellement fermer le consumer
                if (typeof ActionCable !== 'undefined' && ActionCable.consumer) {
                    ActionCable.consumer.disconnect();
                    debugLog("ActionCable consumer disconnected.");
                }
                debugLog("Logged out, redirecting to login.");
                window.location.href = "connection.html"; // Assurez-vous que le nom du fichier est correct
            });

            quickGameButton.addEventListener("click", async function() {
                debugLog("Bouton Partie Rapide cliqué.");
                if (!token) {
                    debugLog("Pas de token pour l'action Partie Rapide. Redirection vers la connexion.");
                    window.location.href = "connection.html";
                    return;
                }
                // Vider les anciens messages de jeu
                messagesDiv.innerHTML = ""; 

                try {
                    debugLog("Envoi de la requête pour une partie rapide...");
                    const response = await fetch('http://localhost:3000/games/quick_game', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    });

                    const responseData = await response.json(); // Toujours essayer de lire la réponse JSON

                    if (response.ok) {
                        debugLog("Réponse de Partie Rapide reçue: " + JSON.stringify(responseData));
                        alert(`Partie rejointe/créée ! ID: ${responseData.game_id}, Votre GameUser ID: ${responseData.game_user_id}, Statut: ${responseData.game_status}`);
                        // S'abonner au channel ActionCable spécifique à cette partie
                        if (responseData.game_id) {
                            subscribeToGameChannel(responseData.game_id);
                        } else {
                            debugLog("Aucun game_id reçu, impossible de s'abonner au channel de jeu.");
                        }
                    } else {
                        debugLog(`Erreur lors de la requête de partie rapide: ${response.status} - ${responseData.error || response.statusText}. Détails: ${JSON.stringify(responseData.details)}`);
                        alert(`Erreur: ${responseData.error || response.statusText}`);
                    }
                } catch (error) {
                    debugLog("Erreur JavaScript lors de l'appel à Partie Rapide: " + error);
                    alert("Une erreur s'est produite lors de la tentative de rejoindre une partie rapide.");
                }
            });

            customGameButton.addEventListener("click", function() {
                debugLog("Bouton Partie Personnalisée cliqué.");
                alert("Fonctionnalité Partie Personnalisée à implémenter !");
            });
        });
    </script>
</body>
</html> 